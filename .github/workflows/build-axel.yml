name: Build Axel for Windows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          update: true
          install: |
            base-devel
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-wolfssl

      - name: Prepare build environment
        shell: msys2 {0}
        run: |
          cd axel-windows
          git clone https://github.com/axel-download-accelerator/axel.git axel-src
          cd axel-src
          sed -i '/\[\*mingw32\], \[/a \    AC_DEFINE([HAVE_BUILTIN_CLZLL], [1], [Force builtin function detection])' configure.ac && \
          sed -i '/AX_GCC_BUILTIN\(\[__builtin_clzll\]\)/d' configure.ac && \
          sed -i '/AS_IF\(\[test "x$ax_cv_have___builtin_clzll" = xno\], \[/d' configure.ac && \
          sed -i '/AC_MSG_ERROR\(\[Support for __builtin_clzll is required\]\)/d' configure.ac && \
          sed -i '/AXEL_CHECK_MACRO(\[O_NONBLOCK\]/d' configure.ac && \
          sed -i '/AM_GNU_GETTEXT/d' configure.ac && \
          sed -i '/AM_GNU_GETTEXT_VERSION/d' configure.ac

      - name: Configure for Windows build
        shell: msys2 {0}
        run: |
          cd axel-src
          rm -f config.cache config.log
          export ac_cv_header_arpa_inet_h=yes
          export ac_cv_header_unistd_h=yes
          export ac_cv_header_netdb_h=yes
          export ac_cv_header_sys_socket_h=yes
          export ac_cv_header_sys_ioctl_h=yes
          export ac_cv_header_sys_time_h=yes
          export ac_cv_header_fcntl_h=yes
          export ac_cv_header_limits_h=yes
          export ac_cv_header_locale_h=yes
          export ac_cv_header_stdlib_h=yes
          export ac_cv_func_inet_ntoa=yes
          export ac_cv_func_getaddrinfo=yes
          export ac_cv_func_gettimeofday=yes
          export ac_cv_func_socket=yes
          export ac_cv_func_select=yes
          export ac_cv_func_malloc=yes
          export ac_cv_func_memset=yes
          export ac_cv_func_realloc=yes
          export ac_cv_func_strerror=yes
          export ac_cv_func_strcasecmp=yes
          export ac_cv_func_strncasecmp=yes
          export ac_cv_func_strchr=yes
          export ac_cv_func_strrchr=yes
          export ac_cv_func_strstr=yes
          export ac_cv_func_strtoul=yes
          export ac_cv_func_strtoll=yes
          export ac_cv_func_strpbrk=yes
          export ac_cv_func_nanosleep=yes
          export ac_cv_func_inet_ntop=yes
          export ac_cv_func_inet_pton=yes
          export ac_cv_func_getopt=yes
          export ac_cv_func_strlcpy=yes
          export ac_cv_func_strlcat=yes
          ./configure --host=x86_64-w64-mingw32 --disable-nls CFLAGS="-static -DWIN32 -DHAVE_ARPA_INET_H=0 -include winsock2.h -include ws2tcpip.h" LIBS="-lws2_32 -lssl -lcrypto"

      - name: Build
        shell: msys2 {0}
        run: |
          cd axel-src
          make clean
          make

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: axel-windows
          path: axel-src/axel.exe
